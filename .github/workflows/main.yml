name: Deploy to EC2
run-name: "${{ github.actor }} deploy to EC2"
on: [push]
jobs:
    Deploy-To-EC2:
        runs-on: self-hosted
        steps:
            - run: echo "ðŸŽ‰ The job was automatically triggered by a ${{ github.event_name }} event."
            - run: echo "ðŸ§ This job is now running on a ${{ runner.os }} server hosted by GitHub!"
            - run: echo "ðŸ”Ž The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
        
            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v1
              with:
                aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                aws-secret-key-id: ${{ secrets.AWS_SECRET_KEY_ID }}
                aws-region: ${{env.AWS_REGION}}
        
            - name: Deploy to EC2
              uses: actions/checkout@v4
              env:
                 PRIVATE_KEY: ${{secrets.SSH_PRIVATE_KEY}}
                 HOSTNAME: ${{secrets.AWS_EC2_ENDPOINT}}
                 USER_NAME: ${{secrets.AWS_EC2_USERNAME}}
            - run: |
                echo "$PRIVATE_KEY" > personal_blog.pem && chmod 600 personal_blog.pem
                ssh -i personal_blog.pem ${USER_NAME}@${HOSTNAME} '
                
                    cd /home/ubuntu/Projects/personal_blog &&
                    git fetch --all &&
                    git pull &&
                    sudo bun install &&
                    sudo bun run build &&
                    sudo pm2 stop ./dist/src/server.js &&
                    sudo pm2 start ./dist/src/server.js
                    '