name: Deploy to EC2
run-name: "${{ github.actor }} deploy to EC2"
on: [push]
jobs:
    Clean-Docker:
        environment: production
        runs-on: self-hosted
        steps:
            - run: echo "🧹 Cleanup docker images, containers and instances"
            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v1
              with:
                aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY_ID }}
                aws-region: ${{ secrets.AWS_REGION }}
            - run: "cd /home/ubuntu/Projects/personal_blog/server"
            - run: "docker compose down"
    Deploy-To-EC2:
        environment: production
        runs-on: self-hosted
        needs: Clean-Docker
        steps:
            - run: echo "🎉 The job was automatically triggered by a ${{ github.event_name }} event."
            - run: echo "🐧 This job is now running on a ${{ runner.os }} server hosted by GitHub!"
            - run: echo "🔎 The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."
            - run: echo "✨ AWS REGION:${{secrets.AWS_REGION}} ."

            - name: Configure AWS credentials
              uses: aws-actions/configure-aws-credentials@v1
              with:
                aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
                aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY_ID }}
                aws-region: ${{ secrets.AWS_REGION }}
        
            - name: Deploy to EC2
              uses: actions/checkout@v4
              env:
                 HOSTNAME: ${{secrets.AWS_EC2_ENDPOINT}}
                 USER_NAME: ${{secrets.AWS_EC2_USERNAME}}
            - run: echo "${{secrets.AWS_SSH_PRIVATE_KEY}}" > personal_blog.pem && chmod 600 personal_blog.pem
            - run: ssh -i personal_blog.pem ${USER_NAME}@${HOSTNAME} 
            - run: cd /home/ubuntu/Projects/personal_blog/server && git fetch --all && git pull && bun install && rm -rf dist && bun run build
                    
